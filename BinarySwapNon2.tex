% $Id: template.tex 11 2007-04-03 22:25:53Z jpeltier $

\documentclass{vgtc}                          % final (conference style)
%\documentclass[review]{vgtc}                 % review
%\documentclass[widereview]{vgtc}             % wide-spaced review
%\documentclass[preprint]{vgtc}               % preprint
%\documentclass[electronic]{vgtc}             % electronic version

%% Uncomment one of the lines above depending on where your paper is
%% in the conference process. ``review'' and ``widereview'' are for review
%% submission, ``preprint'' is for pre-publication, and the final version
%% doesn't use a specific qualifier. Further, ``electronic'' includes
%% hyperreferences for more convenient online viewing.

%% Please use one of the ``review'' options in combination with the
%% assigned online id (see below) ONLY if your paper uses a double blind
%% review process. Some conferences, like IEEE Vis and InfoVis, have NOT
%% in the past.

%% Figures should be in CMYK or Grey scale format, otherwise, colour 
%% shifting may occur during the printing process.

%% These few lines make a distinction between latex and pdflatex calls and they
%% bring in essential packages for graphics and font handling.
%% Note that due to the \DeclareGraphicsExtensions{} call it is no longer necessary
%% to provide the the path and extension of a graphics file:
%% \includegraphics{diamondrule} is completely sufficient.
%%
\ifpdf%                                % if we use pdflatex
  \pdfoutput=1\relax                   % create PDFs from pdfLaTeX
  \pdfcompresslevel=9                  % PDF Compression
  \pdfoptionpdfminorversion=7          % create PDF 1.7
  \ExecuteOptions{pdftex}
  \usepackage{graphicx}                % allow us to embed graphics files
  \DeclareGraphicsExtensions{.pdf,.png,.jpg,.jpeg} % for pdflatex we expect .pdf, .png, or .jpg files
\else%                                 % else we use pure latex
  \ExecuteOptions{dvips}
  \usepackage{graphicx}                % allow us to embed graphics files
  \DeclareGraphicsExtensions{.eps}     % for pure latex we expect eps files
\fi%

%% it is recomended to use ``\autoref{sec:bla}'' instead of ``Fig.~\ref{sec:bla}''
\graphicspath{{figures/}{pictures/}{images/}{./}} % where to search for the images

\usepackage{microtype}                 % use micro-typography (slightly more compact, better to read)
\PassOptionsToPackage{warn}{textcomp}  % to address font issues with \textrightarrow
\usepackage{textcomp}                  % use better special symbols
\usepackage{mathptmx}                  % use matching math font
\usepackage{times}                     % we use Times as the main font
\renewcommand*\ttdefault{txtt}         % a nicer typewriter font
\usepackage{cite}                      % needed to automatically sort the references
\usepackage{tabu}                      % only used for the table example
\usepackage{booktabs}                  % only used for the table example
\usepackage{xspace}
%% We encourage the use of mathptmx for consistent usage of times font
%% throughout the proceedings. However, if you encounter conflicts
%% with other math-related packages, you may want to disable it.

\usepackage{color}
\definecolor{yellow}{rgb}{1,1,0}
\definecolor{black}{rgb}{0,0,0}
\definecolor{ltcyan}{rgb}{.75,1,1}
\definecolor{red}{rgb}{1,0,0}
\definecolor{gray}{rgb}{.6,.6,.6}
\definecolor{darkred}{rgb}{0.5,0,0}
\definecolor{darkgreen}{rgb}{0,0.5,0}


%% If you are submitting a paper to a conference for review with a double
%% blind reviewing process, please replace the value ``0'' below with your
%% OnlineID. Otherwise, you may safely leave it at ``0''.
\onlineid{0}

%% declare the category of your paper, only shown in review mode
\vgtccategory{Research}

%% allow for this line if you want the electronic option to work properly
\vgtcinsertpkg

%% In preprint mode you may define your own headline.
%\preprinttext{To appear in an IEEE VGTC sponsored conference.}

% Cite commands I use to abstract away the different ways to reference an
% entry in the bibliography (superscripts, numbers, dates, or author
% abbreviations).  \scite is a short cite that is used immediately after
% when the authors are mentioned.  \lcite is a full citation that is used
% anywhere.  Both should be used right next to the text being cited without
% any spacing. \hcite is a citation that I am hiding, perhaps because I am
% nearing the maximum number of citations for a journal.
\newcommand*{\lcite}[1]{~\cite{#1}}
\newcommand*{\scite}[1]{~\cite{#1}}
\newcommand*{\hcite}[1]{}

\newcommand{\etal}{et al.\xspace}

\newcommand*{\keyterm}[1]{\emph{#1}}

\newcommand{\fix}[1]{{\color{red}\textsc{[#1]}}}
%\newcommand{\fix}[1]{}

% Avoid putting figures on their own page.
\renewcommand{\textfraction}{0.05}
\renewcommand{\topfraction}{0.95}
\renewcommand{\bottomfraction}{0.95}

% Make sure this is big enough so that only big figures end up on their own
% page but small enough so that if a figure does have to be on its own
% page, it won't push everything to the bottom because it's not big enough
% to have its own page.
\renewcommand{\floatpagefraction}{.75}

\newcommand{\textalgorithm}[1]{\textsf{#1}\xspace}

\newcommand{\binaryswap}{\textalgorithm{binary swap}}
\newcommand{\Binaryswap}{\textalgorithm{Binary swap}}

\newcommand{\ttswap}{\textalgorithm{2-3 swap}}
\newcommand{\naive}{\textalgorithm{naive}}
\newcommand{\Naive}{\textalgorithm{Naive}}
\newcommand{\telescoping}{\textalgorithm{telescoping}}
\newcommand{\Telescoping}{\textalgorithm{Telescoping}}
\newcommand{\remainder}{\textalgorithm{remainder}}
\newcommand{\Remainder}{\textalgorithm{Remainder}}

\newcommand{\radixk}{\textalgorithm{radix-k}}
\newcommand{\Radixk}{\textalgorithm{Radix-k}}

\newcommand{\directsend}{\textalgorithm{direct send}}
\newcommand{\Directsend}{\textalgorithm{Direct send}}

%% Paper title.

\title{Binary-Swap with Odd Factors}

%% This is how authors are specified in the conference style

%% Author and Affiliation (single author).
%%\author{Roy G. Biv\thanks{e-mail: roy.g.biv@aol.com}}
%%\affiliation{\scriptsize Allied Widgets Research}

%% Author and Affiliation (multiple authors with single affiliations).
%%\author{Roy G. Biv\thanks{e-mail: roy.g.biv@aol.com} %
%%\and Ed Grimley\thanks{e-mail:ed.grimley@aol.com} %
%%\and Martha Stewart\thanks{e-mail:martha.stewart@marthastewart.com}}
%%\affiliation{\scriptsize Martha Stewart Enterprises \\ Microsoft Research}

%% Author and Affiliation (multiple authors with multiple affiliations)
%% \author{Roy G. Biv\thanks{e-mail: roy.g.biv@aol.com}\\ %
%%         \scriptsize Starbucks Research %
%% \and Ed Grimley\thanks{e-mail: ed.grimley@aol.com}\\ %
%%      \scriptsize Grimley Widgets, Inc. %
%% \and Martha Stewart\thanks{e-mail: martha.stewart@marthastewart.com}\\ %
%%      \parbox{1.4in}{\scriptsize \centering Martha Stewart Enterprises \\ Microsoft Research}}

\author{
  Kenneth Moreland\thanks{e-mail: kmorel@sandia.gov}\\
  \scriptsize Sandia National Laboratories
}

%% A teaser figure can be included as follows, but is not recommended since
%% the space is now taken up by a full width abstract.
%\teaser{
%  \includegraphics[width=1.5in]{sample.eps}
%  \caption{Lookit! Lookit!}
%}

%% Abstract section.
\abstract{
  A key component of most large-scale rendering systems is binary swap, a parallel image compositing algorithm, or a variant of it.
  Although shown to be very efficient, one of the classic limitations of binary swap is that it only works on a number of processes that is a perfect power of 2.
  Multiple variations of binary swap have been independently introduced to overcome this limitation and handle process counts that have factors that are not 2.
  To date, few of these approaches have been directly compared against each other, making it unclear which approach is best.
  This paper presents a fresh implementation of each of these methods using a common software framework to make them directly comparable.
  These methods to run binary swap with odd factors, plus one more introduced in this paper, are directly compared.
  The results show that some simple compositing approaches work as well or better than more complex algorithms that are more difficult to implement.
} % end of abstract

%% ACM Computing Classification System (CCS). 
%% See <http://www.acm.org/about/class> for details.
%% We recommend the 2012 system <http://www.acm.org/about/class/class/2012>
%% For the 2012 system use the ``\CCScatTwelve'' which command takes four arguments.
%% The 1998 system <http://www.acm.org/about/class/class/2012> is still possible
%% For the 1998 system use the ``\CCScat'' which command takes four arguments.
%% In both cases the last two arguments (1998) or last three (2012) can be empty.

\CCScatlist{
  \CCScatTwelve{Computing methodologies}{Computer graphics}{Rendering}{};
  \CCScatTwelve{Computing methodologies}{Parallel computing methodologies}{Parallel algorithms}{Massively parallel algorithms}
}

%\CCScatlist{
  %\CCScat{H.5.2}{User Interfaces}{User Interfaces}{Graphical user interfaces (GUI)}{};
  %\CCScat{H.5.m}{Information Interfaces and Presentation}{Miscellaneous}{}{}
%}

%% Copyright space is enabled by default as required by guidelines.
%% It is disabled by the 'review' option or via the following command:
% \nocopyrightspace

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%% START OF THE PAPER %%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

%% The ``\maketitle'' command must be the first command after the
%% ``\begin{document}'' command. It prepares and prints the title block.

%% the only exception to this rule is the \firstsection command
\firstsection{Introduction}

\maketitle

%% \section{Introduction} %for journal use above \firstsection{..} instead
Parallel rendering is critical for large-scale scientific visualization.
Broadly speaking, there are two general approaches to render data in a distributed parallel system.
The first approach is to distribute the geometry such that each process can completely render a subregion of the screen (known as \keyterm{sort-first} rendering\lcite{Molnar1994}).
The second approach is to have each process render a full image with partial data and then combine (a.k.a. composite or reduce) these to a single, complete image (known as \keyterm{sort-last} rendering\lcite{Molnar1994}).
It has long been shown that for large parallel jobs, sort-last provides much better scalability\lcite{Wylie2001}.
The efficiency of sort-last parallel rendering with image compositing has been demonstrated in many systems\lcite{Childs2010,Moreland2011:SC,Peterka2009:ICPP,Peterka2013}.

The efficiency of sort-last parallel rendering depends on the ability to composite the images generated by each process into a single image.
One of the most well known algorithms, and one still use commonly to date, is \binaryswap\lcite{BinarySwap2}.
\Binaryswap is popular because it is straightforward to implement and has good scaling behavior in terms of data transfer and number of iterations\fix{cite}.

One natural problem with \binaryswap is that because it iteratively divides processors into two groups, and these groups need to be the same size, it only works well when the number of processes is a perfect power of 2.
Multiple variations of \binaryswap have been independently introduced to overcome this limitation, but few have previously been directly compared with each other.
This paper reviews these existing approaches and introduces a new one.
It then describes a miniature rendering application built to easily implement these algorithms and provides the results of comparing these algorithms with each other.

\section{Compositing Algorithms}

\subsection{Base Binary Swap}
\label{sec:BinarySwap}

\subsection{Binary Swap Variations for Odd Process Factors}
\label{sec:BinarySwapVariations}

\subsubsection{Naive}

\subsubsection{2-3 Swap}

\subsubsection{Telescoping}

\subsubsection{Remainder}

\subsection{Alternatives to Binary Swap}
\label{sec:BinarySwapAlternatives}

Direct Send

Radix-k

\section{Parallel Rendering Mini-App}

\section{Results}
\label{sec:Results}

The experiments were run on the Sky Bridge cluster at Sandia National Laboratories\lcite{SkyBridge}.
Sky Bridge is a water cooled Cray capacity cluster with 1,848 nodes (although at most 512 nodes were used at any one time during these experiments).
Each node contains 2 2.6 GHz Intel Xeon E5-2670 processors, each with 8 cores (16 cores total).
The nodes are connected with a Infiniband interconnect.
The experiments were run in ``virtual node'' mode where each core ran a separate MPI process (except where specified in Section \ref{sec:VNCompare}).

The experiments rendered a simple scene where each process rendered an opaque box \fix{Should be an image of this somewhere.}.
Each experiment has a minimum of 10 trials (rendered frames).
Each trial is performed from random camera rotations around the geometry (although these random locations are consistent across experiments by using the same pseudorandom number generator seed).
Rendering times for two different image sizes are reported: HDTV ($1920 \times 1080$) and 8K UHD ($7680 \times 4320$).

The compositing engaged active pixel encoding for compression (except where specified in Section \ref{sec:FullImages}).
The times reported here are specifically the time to divide the image and blend pixels.
This leaves the final composited image divided across many MPI processes.
The time to gather the image pieces is not reported except where discussed in Section \ref{sec:Gather}.
The time to map the geometry to pixels is not reported as this time is independent from the compositing algorithm.

\subsection{Algorithm Comparison and Scaling}
\label{sec:Scaling}

The first experiment performs a scaling study of the behavior of the \binaryswap algorithm with the 4 variations discussed in Section \ref{sec:BinarySwapVariations}.
The tests include runs on 64 processes (4 real nodes) up to 8192 cores (512 real nodes).
It is impractical to run an experiment on every possible number of processes.
Instead jobs are chosen such that the number of real nodes where all the prime factors are either 2 or 3.
This hits all jobs sizes that are a perfect power of 2 and many in between at odd spacing.
The results of these experiments are shown in Figures \ref{fig:ScalingHDTV} and \ref{fig:Scaling8K}.
(The plots are labeled as ``Partial Composite Time'' because these times include only splitting the images and blending pixels.
The fully composited image is left in pieces scattered across the MPI processes.
Section \ref{sec:Gather} discusses the collection of these pieces.)

\begin{figure}
  \centering
  \includegraphics[width=\linewidth]{scaling-hdtv}
  \caption{
    Performance of variations of \binaryswap for HDTV ($1920 \times 1080$) images.
    The performance of the IceT rendering library is also given for reference.
  }
  \label{fig:ScalingHDTV}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=\linewidth]{scaling-8k}
  \caption{
    Performance of variations of \binaryswap for 8K UHD ($7680 \times 4320$) images.
    The performance of the IceT rendering library is also given for reference.
  }
  \label{fig:Scaling8K}
\end{figure}

A first observation about the data is to note that the naive algorithm pays a significant but consistent penalty for running on a number of processes that is not a power of 2.
This is consistent with the findings of Yu et al.\scite{23Swap}.

A second observation is that the \ttswap algorithm behaves well up to 1024 processes (which is as large as was measured by Ye et al.\scite{23Swap}), but the performance starts to deteriorate on larger sizes, particularly for the HDTV images.
This appears to be caused by the time taken to build the compositing tree, which is complex for \ttswap and has to take into account all the processes.
Figure \ref{fig:23SwapOverhead} demonstrates the fraction of time spent in building the 2-3 compositing tree.

\begin{figure}[htb]
  \centering
  \fix{Bar chart with top of bars showing the time to build the 2-3 swap compositing tree and a different shade of bars showing the remaining time.}
  \caption{
    Average times for \ttswap compositing.
    The top darker shade shows the time spent building the compositing tree whereas the bottom lighter shade shows the remainder of the algorithm (transferring data, blending colors, etc.).
  }
  \label{fig:23SwapOverhead}
\end{figure}

A third observation is that both the \telescoping and \remainder versions of binary swap perform very well throughout the entirety of the experiments.
This is somewhat counterintuitive for the \remainder algorithm, which, much like the poor performing \naive algorithm, lets processes go idle.
However, unlike the \naive algorithm, \remainder delays letting processes go idle until as late as possible.
More importantly, \remainder has fewer iterations than \naive with each iteration dividing the amount of work done by each process in half.

A fourth observation is that all of the \binaryswap algorithms implemented in miniGraphics perform less well than the IceT software.
IceT uses a combination of \radixk and \telescoping, but the real performance gain is in its high-speed blending and management of memory to reduce allocation and messages.
In contrast, miniGraphics sacrifices some efficiency for readability of code and ease of implementation to facilitate comparisons like those in this paper.

\subsection{No Image Compression}
\label{sec:FullImages}

\subsection{Virtual Node vs. Pure Distributed}
\label{sec:VNCompare}

\subsection{Aberrant Readings}

\subsubsection{Inconsistent Gather Times}
\label{sec:Gather}

\subsubsection{Errors in 2-3 Swap}
\label{sec:2-3SwapErrors}

\section{Conclusions}

%% if specified like this the section will be committed in review mode
\acknowledgments{
  \fix{Sandia and ASCR acknowledgments here.}
}

%\bibliographystyle{abbrv}
%\bibliographystyle{abbrv-doi}
\bibliographystyle{abbrv-doi-narrow}
%\bibliographystyle{abbrv-doi-hyperref}
%\bibliographystyle{abbrv-doi-hyperref-narrow}

\bibliography{BinarySwapNon2}
\end{document}
